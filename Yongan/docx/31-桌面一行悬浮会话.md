# 桌面一行悬浮会话窗口 MVP 实施计划

- 编号归属：`31` 号文档仅用于桌面极简悬浮窗口主题（与 `30` 号 MCP 市场文档解耦）。
- 对应 plan 条目: 2026-02-19（桌面一行悬浮会话窗口 MVP 实施计划）

## 目标与边界（按本轮确认）
- 目标: 做一个“单会话”的桌面悬浮聊天入口，默认一行输入，发送后展开同宽结果窗展示回答。
- 范围:
  - 一行悬浮条（输入框 + 发送 + 模型选择）。
  - 可切换置顶（always on top）。
  - 可调透明度（建议 40%-100%）。
  - 发送后展开结果窗，宽度与悬浮条一致，展示流式回答。
- 非目标（本期不做）:
  - 边缘吸附/磁吸。
  - 多会话、历史列表、多结果窗。
  - 复杂工作流（工具链可视化、文件树、Persona 管理）。

## 现状基线（可复用）
- 桌面端技术栈已是 `Tauri + React`，入口在 `apps/setup-center/src-tauri/src/main.rs` 与 `apps/setup-center/src/App.tsx`。
- 现有聊天流式链路已可复用，核心在 `apps/setup-center/src/views/ChatView.tsx`（SSE/流式解析、模型选择、消息渲染）。
- 当前仅有 `main` 窗口；托盘隐藏/显示机制已具备，可作为悬浮模式入口复用。

## 架构方案（MVP）
1. 窗口模型
- `main`：原完整界面保留，作为“完整控制台”。
- `float_bar`：一行悬浮条窗口（小高度、可拖拽、可置顶、可透明）。
- `float_result`：结果展示窗口（同宽、纵向展开，展示流式回答）。

2. 数据与交互
- 悬浮条负责输入与模型选择，点击发送后:
  - 打开/激活 `float_result`；
  - 将两窗口宽度对齐；
  - 结果窗开始流式请求并渲染。
- 会话固定为单会话 ID（例如 `floating_default`），不引入会话列表。
- 模型列表复用现有 endpoint 数据源，避免新增后端接口。

3. 配置持久化
- 新增浮窗偏好配置（置顶、透明度、最近模型、位置/尺寸）到 state 文件（`AppStateFile`）。
- Rust 提供 `get/set` 命令，前端窗口启动时读取，变更后即时写回。

## 开发拆分与工时（1 人）
1. Phase 0：技术预研与最小骨架（0.5 天）
- 验证 Tauri 多窗口在当前工程中的创建、显示、隐藏与焦点行为。
- 验证透明度与置顶在 Windows 可用性。

2. Phase 1：窗口基础能力（1 天）
- 在 `apps/setup-center/src-tauri/src/main.rs` 增加浮窗创建与窗口控制命令。
- 托盘菜单新增“打开悬浮条/打开完整界面”入口。
- 增加浮窗设置读写命令，并扩展 `AppStateFile`。

3. Phase 2：悬浮条 UI（1 天）
- 新增 `apps/setup-center/src/views/FloatingBarView.tsx`（或等价组件）。
- 提供输入、发送、模型选择、置顶开关、透明度调节。
- 支持 Enter 发送、Esc 收起结果窗（可选）。

4. Phase 3：结果窗 UI + 流式渲染（1.5 天）
- 新增 `apps/setup-center/src/views/FloatingResultView.tsx`。
- 抽取 `ChatView` 的流式请求逻辑到共享模块（如 `apps/setup-center/src/lib/chat_stream.ts`），避免重复实现。
- 实现“发送即展开，同宽对齐，流式显示，完成后可保留内容”。

5. Phase 4：联调与回归（1 天）
- 回归 Windows 多显示器、125%/150% DPI、置顶切换、透明度边界值。
- 回归服务未启动/请求失败/超时时的结果窗提示。
- 构建验证：`npm --prefix apps/setup-center run build`、Tauri 打包自测。

合计: 约 5-6 个工作日（MVP 可演示版本）。

## 关键交互规范（建议直接作为验收口径）
- 悬浮条默认高度控制在 44-56px，仅一行输入。
- 用户发送后，结果窗在 200ms 内出现（网络请求可继续加载中）。
- 结果窗宽度始终等于悬浮条宽度（用户拖宽任一窗口后即时同步）。
- 置顶开关切换后立即生效；透明度调整实时生效且可持久化。
- 不影响现有完整主界面，用户可随时切回主界面。

## 风险与缓解
- 风险 1: 多窗口焦点抢占导致输入中断。
  - 缓解: 发送后仅激活结果窗一次；输入焦点回退策略固定在悬浮条输入框。
- 风险 2: 透明窗口在 Windows 下出现点击区域异常。
  - 缓解: MVP 不做点击穿透，只做透明度；保持标准 hit-test。
- 风险 3: 复用 Chat 流式逻辑时出现双份状态管理。
  - 缓解: 提前抽共享 `chat_stream` 模块，窗口仅持有展示状态。

## MVP 验收标准
- 可从托盘或主界面打开悬浮条。
- 悬浮条可输入并发送消息，可选择模型。
- 可切换置顶，可调整透明度并在重启后保留。
- 发送后自动展开同宽结果窗，稳定显示流式回答。
- 全流程仅维护一个会话，不出现会话列表或历史侧栏。

## 后续迭代（MVP 之后）
1. 吸附/贴边与智能避让。
2. 全局快捷键唤起悬浮条。
3. 结果窗折叠摘要与最近 N 条快捷回看。
4. 多会话与多任务队列。

## 快速落地实现（20 分钟版本）
- 实施日期: 2026-02-19
- 实施目标: 在最短时间内交付“可用的一行悬浮聊天体验”，同时保留后续扩展到独立窗口/多窗口的架构接口。

## 三形态命名约定（强约定）
- 该约定已写入 `apps/setup-center/src/App.tsx` 注释，后续需求讨论与开发均按此定义：
1. `traditional`（传统）
- 完整三栏形态（文件树 + 主区 + 导航）。

2. `normal`（正常）
- 轻量聊天形态（对应历史版本的 `minimal` 行为）。
- 两侧面板隐藏，保留主聊天工作区。

3. `minimal`（极简）
- 一行悬浮输入形态（`FloatingChatView` 紧凑版）。
- 发送后展开同宽结果面板。
- 顶部模式切换按钮在该状态下保留，可直接切回其他形态。

## 当前实现状态（2026-02-19 更新）
1. 模式切换
- “模式按钮”改为三态循环：`traditional -> normal -> minimal -> traditional`。
- 模式状态持久化到 `localStorage:oap_ui_mode`，兼容旧值迁移：
  - `classic -> traditional`
  - `minimal -> normal`

2. 视图联动策略
- 当 `uiMode=minimal` 时，自动切换到 `floating` 视图。
- 当 `uiMode` 从 `minimal` 切回其他形态时，自动回到 `chat` 视图。

3. 交互保留
- 极简形态下仍保留顶部模式按钮（满足“极简状态下可切换”要求）。
- 传统/正常形态与左右侧栏联动规则：
  - `traditional` 自动打开左右两栏；
  - 用户在 `traditional` 下关闭任一侧栏会自动降级为 `normal`；
  - `normal` 下当左右两栏同时打开时自动升级为 `traditional`。

4. 透明度兼容策略（重要）
- 保留 Rust 命令 `set_window_opacity` 作为稳定接口，但在当前 `tauri 2.10` 依赖组合下不调用原生 `set_opacity`（该 API 不可用）。
- 透明度由前端 `FloatingChatView` 使用 CSS `opacity` 实现，保证功能可用与后续可平滑切回原生实现。

5. 极简窗口形态修复（本轮）
- 移除右侧导航“悬浮聊”入口，避免与“极简模式”概念重复。
- `uiMode=minimal` 时不再只是页面布局变化，而是触发窗口级切换：
  - 主窗口切为无边框、置顶、小尺寸、屏幕上方居中（悬浮对话框体感）。
  - 退出 `minimal` 自动恢复原窗口尺寸、位置、边框和置顶状态。
- 对应命令：`set_minimal_floating_mode`（Rust），由前端 `uiMode` 变化自动调用。

6. 极简纯对话窗修复（本轮）
- `minimal` 不再复用主界面的工具栏与配置操作区，改为“纯对话悬浮窗”单独渲染：
  - 保留：模型选择、输入、发送、结果面板、模式切换按钮；
  - 移除：语言切换、配置按钮、工作区/文件预览等主界面按钮。
- 悬浮窗增强：
  - 可拖动（顶部拖动条）；
  - 可左右拉伸（左右边缘拖拽）；
  - 可最小化；
  - 可一键置顶/取消置顶；
  - 发送后自动展开同宽结果面板（并自动调高窗口高度）。

### 已落地能力
1. 悬浮聊天视图
- 新增 `apps/setup-center/src/views/FloatingChatView.tsx`。
- 提供一行输入、模型选择、发送按钮。
- 发送后自动展开“同宽结果面板”，显示流式回答（单会话 `floating_default`）。

2. 置顶与透明度（窗口级能力）
- 在 `apps/setup-center/src-tauri/src/main.rs` 新增窗口命令:
  - `set_window_always_on_top`
  - `set_window_opacity`
- 悬浮视图可直接控制窗口置顶与透明度。

3. 偏好持久化（为扩展预留）
- Rust `AppStateFile` 新增 `floating_ui` 字段（`FloatingUiPrefs`）。
- 新增命令:
  - `get_floating_ui_prefs`
  - `set_floating_ui_prefs`
- 应用启动时自动应用 `always_on_top + opacity` 偏好，保证行为一致。

4. 主界面接入
- `apps/setup-center/src/App.tsx` 新增 `floating` 视图路由，作为 `uiMode=minimal` 的承载页。
- 已移除侧栏“悬浮聊/Floating”独立入口，避免与“极简模式”双入口冲突；当前以模式按钮切换为唯一入口。
- 与现有服务启动链路复用，不引入新后端 API。

### 兼容性与扩展性说明
- 当前实现复用主窗口（`main`）承载悬浮体验，避免多窗口改造带来的短期风险。
- 置顶/透明度与偏好存储已下沉到 Rust 命令层，后续切换为 `float_bar` 独立窗口时，前端调用层可保持不变，只需改命令内部窗口目标。
- 当前透明度为“命令接口 + 前端渲染”双层方案；若后续 tauri 提供/恢复原生 API，可直接在命令内部启用原生分支。
- 流式协议复用 `/api/chat` 现有事件格式（最小处理 `text_delta/error/done`），未来可平滑接入 Plan/Tool/Thinking 事件。

## 可扩展内容（按优先级）
1. 窗口拆分扩展（高优先）
- 将当前主窗口承载的极简形态拆分为独立 `float_bar/float_result` 双窗口。
- 前端无需改业务逻辑，仅调整 Rust 命令将窗口目标从 `main` 改为新窗口。

2. 流式事件增强（高优先）
- 在极简结果面板接入 `plan_created/plan_step_updated/thinking/tool_call_*`。
- 保持当前 `text_delta` 最小链路作为兜底。

3. 偏好扩展（中优先）
- 在 `floating_ui` 中新增：窗口位置、尺寸、结果窗默认高度、快捷键等字段。
- 继续复用 `get/set_floating_ui_prefs`，避免新增配置通道。

4. 交互增强（中优先）
- 支持“按 Enter 发送 + Ctrl+Enter 换行”（可配置）。
- 支持结果窗自动收起策略（超时/手动/固定）。

### 本轮变更文件
- `apps/setup-center/src/views/FloatingChatView.tsx`（新增）
- `apps/setup-center/src/App.tsx`
- `apps/setup-center/src/types.ts`
- `apps/setup-center/src/styles.css`
- `apps/setup-center/src/i18n/zh.json`
- `apps/setup-center/src/i18n/en.json`
- `apps/setup-center/src-tauri/src/main.rs`

## 体验优化：单行布局 + 仅水平拉伸 + 默认传统模式（2026-02-19）

对应 plan 条目：2026-02-19（极简悬浮窗体验优化：单行布局 + 仅水平拉伸 + 默认传统模式）

### 问题
1. 拖动条与输入框分两行，窗口高度过大，排版混乱
2. 窗口可上下拉伸，破坏"一行悬浮条"定位
3. 启动默认进极简模式，应为传统模式

### 方案
1. **单行合并**：移除独立拖动条，卡片背景整体可拖动；模型选择/输入/发送/模式/置顶/最小化/设置全在一行
2. **仅水平拉伸**：通过 `setMinSize(420, h)` + `setMaxSize(9999, h)` 锁定高度，宽度自由；高度随状态程序化切换（64/140/160/480）
3. **默认传统**：`useState<UiMode>("traditional")` 固定初始值，不再读 localStorage
4. **图标化**：模式切换 → `IconMenu`，置顶 → `IconPin`（高亮 `var(--brand)`），减少文字占用
5. **Rust 同步**：`target_height` 从 112 降至 64

### 变更文件
- `apps/setup-center/src/App.tsx` — 默认模式 + IconMenu
- `apps/setup-center/src/views/FloatingChatView.tsx` — 单行布局 + 高度锁定
- `apps/setup-center/src/styles.css` — padding 缩减
- `apps/setup-center/src/icons.tsx` — 新增 IconPin
- `apps/setup-center/src-tauri/src/main.rs` — target_height 64

## 精修补丁：白蓝对齐 + 拖拽恢复 + 透明度按钮（2026-02-19）

对应 plan 条目：2026-02-19（极简浮窗修复：白蓝对齐/拖拽恢复/透明度按钮）

### 问题复现
1. 极简状态下蓝色底框与白色对话窗右侧未对齐，且底部留白明显。
2. 极简悬浮窗拖动不稳定，用户体感“拖不动”。
3. 缺少专门透明度调节入口。

### 本轮修复
1. 布局与间距修正
- 极简容器横向内边距改为 `0`，避免白窗与底框左右错位。
- 移除重复纵向间距来源：新增 `.floatingFrameCompact .card + .card { margin-top: 0; }`，仅保留组件内 `gap`。
- 悬浮窗高度策略调整为更紧凑的状态值：基础 `60`、折叠结果 `124`、展开结果 `560`，并在透明度面板打开时额外补偿高度，消除底部异常空白。

2. 拖拽能力恢复
- 在输入行增加独立拖拽手柄按钮（`floatingDragHandle`），同时使用 `data-tauri-drag-region` 与 `startDragging()` 双保险。
- 保留左右边缘拉伸逻辑，不影响“仅水平拉伸”约束。

3. 透明度调节按钮
- 新增紧凑按钮 `floatingOpacityBtn`（显示当前百分比）。
- 点击展开 `floatingOpacityPanel`，通过滑杆实时调整 `35%~100%` 透明度。
- 调整值即时写入并持久化到 `floating_ui.opacity`。

4. 冗余代码清理
- `FloatingChatView` 移除未使用的 `endpoints` 参数及其调用传参，降低无效耦合。

### 本轮变更文件
- `apps/setup-center/src/views/FloatingChatView.tsx`

## 宽度缩放与防误改注释（2026-02-19）

对应 plan 条目：2026-02-19（极简对话条宽度缩放 0.7 + 防误改注释）

### 目标
1. 当前极简对话条整体缩短为原来的 `0.7`。  
2. 在关键位置补注释，避免后续再次出现“只改外框/拖拽看起来可用但不移动”等误改。  

### 本轮实现
1. 宽度统一缩放
- 以既有基准 `1290` 按 `0.7` 缩放，得到 `903`。
- 前端 `FloatingChatView` 将极简默认宽度改为 `903`（由 `1290 * 0.7` 计算）。
- Rust `set_minimal_floating_mode` 的 `target_width` 同步改为 `903`。

2. 防误改注释
- 在前端宽度常量位置标注“需与 Rust 同步”。
- 在极简根容器 `width:100%` 位置标注“flex shrink-to-fit 历史坑点”。
- 在拖拽入口标注“`startDragging` 历史不稳定，手动位移为主路径”。
- 在 Rust 宽度常量位置标注“与前端常量必须同改”。

### 本轮变更文件
- `apps/setup-center/src/views/FloatingChatView.tsx`
- `apps/setup-center/src-tauri/src/main.rs`
- `apps/setup-center/src/styles.css`
- `apps/setup-center/src/App.tsx`
- `apps/setup-center/src-tauri/src/main.rs`

## 修复失败后二次校正：整窗透明度 + 固定高度 + 滚动条占位清理（2026-02-19）

对应 plan 条目：2026-02-19（极简浮窗修复二次校正：整窗透明度/滚动条占位/固定高度）

### 用户反馈问题
1. 拖拽手柄光标变为拖动态，但窗口位置不变。  
2. 白色对话窗右侧与蓝色背景右边界仍未贴齐。  
3. 透明度只影响白窗，不影响蓝色背景层。  
4. 极简仍出现上下拖动条，不符合“固定高度”。

### 根因归纳
- 透明度设置在白窗容器，未作用于窗口整体层。  
- 极简状态存在高度溢出，触发页面滚动条占位，导致视觉上“右侧不贴齐”。  
- 拖拽手柄使用按钮元素，交互链路受控件事件影响，稳定性不足。  
- 窗口仍处于可缩放状态，存在垂直方向尺寸调整入口。

### 二次修复
1. 整窗透明度
- 极简模式下移除蓝色底背景（`body.oap-minimal-mode`），减少底层错位干扰。
- 透明度改为作用极简根容器（CSS 变量 `--floating-window-opacity`），确保可见层统一变化。

2. 右侧贴齐与滚动条
- 极简容器改为 `overflow:hidden`，并统一居中布局；补 `#root` 全高，避免高度溢出引发滚动条占位。
- 白色卡片显式 `width:100%`，确保与窗口宽度一致。

3. 拖拽稳定性
- 拖拽手柄改为非按钮拖拽区（`div`）。
- 拖动实现改为“双路径”：先调用 `startDragging()`，失败时自动降级为手动 `setPosition` 位移拖动。

4. 固定高度
- Rust 侧 `set_minimal_floating_mode` 将 `resizable` 设为 `false`，禁止上下缩放条。
- 前端继续通过 min/max 高度策略锁定极简高度。

### 本轮变更文件
- `apps/setup-center/src/App.tsx`
- `apps/setup-center/src/views/FloatingChatView.tsx`
- `apps/setup-center/src/styles.css`
- `apps/setup-center/src-tauri/src/main.rs`

## 视觉回调修正：恢复蓝底 + 白窗宽度放大（2026-02-19）

对应 plan 条目：2026-02-19（极简浮窗视觉回调：恢复蓝底 + 白窗宽度放大）

### 变更目标
1. 极简模式恢复蓝色底背景（不再透明化背景层）。
2. 白色对话窗横向宽度提升到约当前 1.5 倍。

### 修正内容
1. 背景层
- 移除“极简模式去蓝底”覆盖规则，恢复默认蓝色渐变背景。
- 保留 `overflow:hidden`，避免极简态出现滚动溢出。

2. 白窗宽度
- Rust `set_minimal_floating_mode` 默认目标宽度由 `860` 调整为 `1290`。
- 白色对话窗在极简态仍使用 `width:100%`，因此随窗口宽度同步变长。

3. 透明度
- 透明度继续通过 `body.opacity` 作用整窗口层，保证蓝底与白窗同步变化。

### 本轮变更文件
- `apps/setup-center/src/views/FloatingChatView.tsx`
- `apps/setup-center/src/styles.css`
- `apps/setup-center/src-tauri/src/main.rs`

## 宽度对齐修正：白窗显式宽度（2026-02-19）

对应 plan 条目：2026-02-19（极简宽度修正：白窗显式宽度与外框对齐）

### 问题
- 上一轮主要放大了窗口外框，白色对话窗仍按自适应宽度渲染，视觉上没有按 1.5 倍同步增长。

### 根因
- 白窗容器在极简态使用 `width: 100% + flex` 的自适应策略，实际渲染宽度未与目标宽度建立强约束。

### 修正
- 在 `FloatingChatView` 中对极简白窗容器设置显式目标宽度：`min(1290px, 100%)`，并保持 `max-width: 100%` 防止溢出。
- 这样白窗宽度与外框目标宽度 `1290` 使用同一基准，视觉上同步放大。

### 本轮变更文件
- `apps/setup-center/src/views/FloatingChatView.tsx`

## 根因修复：白窗真实宽度与拖拽稳定性（2026-02-19）

对应 plan 条目：2026-02-19（极简白窗宽度根因修复：根容器拉伸 + 拖拽稳定化）

### 现象
1. 窗口外框已放大，但白色对话窗视觉上仍偏窄。  
2. 拖拽手柄光标变为拖动态，但窗口在部分环境不移动。  

### 根因
- 极简壳层 `minimalChatOnlyShell` 是 flex 布局，`floatingRoot` 未显式占满宽度，触发 shrink-to-fit。
- 白窗容器即使写了 `width: 100%`，也只会跟随“被收缩后的父容器”。
- 拖拽依赖 `startDragging` 在不同 WebView/窗口状态下稳定性不一致。

### 修复
1. 宽度绑定修复
- 在 `FloatingChatView` 极简态给 `floatingRoot` 增加 `width: 100%`，强制父容器拉伸到窗口宽度。
- 让白窗 `width: 100%` 真正对应窗口宽度，而不是收缩宽度。

2. 拖拽稳定性修复
- 拖拽主路径改为手动位移：`mousedown` 记录起点，`mousemove` 调用 `setPosition` 实时移动窗口。
- 规避 `startDragging` 在部分环境“有拖拽态但不移动”的兼容性问题。

3. 构建修正
- 修复 `@tauri-apps/api/window` 的监视器 API 调用方式：
  - 从 `currentWindow.currentMonitor()` 改为模块函数 `currentMonitor()`。
- 保证前端构建可通过。

### 本轮变更文件
- `apps/setup-center/src/views/FloatingChatView.tsx`
